<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset = "utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>IPhO 2015 - Mumbai, India</title>

		<!--Bootstrap-->
		<link href = "/static/css/bootstrap.min.css" rel = "stylesheet" />
		<!!--Custom CSS-->
		<link href = "/static/css/main.css" rel = "stylesheet" />
	</head>
	<body>
		<div id = "sp-header-wrapper" class = "navbar navbar-defaul navbar-fixed-top">
			<div class = "container-fluid">
				<div class = "navbar-header">
					<a class="navbar-brand" href = "http://www.ipho2015.in">
						<img alt="logo" src = "media/ipho-logo1.png" />
					</a>
				</div>
			</div>
			<div id = "tifr-mast">
				<div id = "tifr-logo"><img class = "right" alt="tifr-logo" src = "/media/tifr-logo-s.png" />
				<br />
				<div id = "out-button" class="right">
				<button id = "chpass-button" type = "button" class = "btn btn-default btn-sm">Change Password</button>
				<button id = "logout-button" type = "button"  class = "btn btn-default btn-sm">
					<span class="glyphicon glyphicon-log-out"></span> Log out
				</button>
				</div>
				<br />
				</div>
				<div id = "hbc-tifr" style = "position:relative;left:110px">
					<div id = "hbc">Homi Bhabha Centre for Education</div>
					<div id = "tifr">Tata Institute of Fundamental Research</div>
				</div>
			</div>
		</div>
		<div id = "document">
			<div role = "tabpanel">
				<ul class = "nav nav-pills" id = "nemo">
					<li role = "presentation" class = "active"><a href = "#home" aria-controls="home" role="tab" data-toggle="tab">Home</a></li>
					<li role = "presentation"><a href = "#vote" aria-controls="vote" role="tab" data-toggle="tab">Vote</a></li>
					<li role = "presentation"><a href = "#trans" aria-controls="vote" role="tab" data-toggle="tab">Translation</a></li>
					<li id = "cvoteb" role = "presentation" style = "display:none;"><a href = "#cvote" aria-controls="cvote" role="tab" data-toggle="tab">Cast Vote</a></li>
					<li id = "rvoteb" role = "presentation" style = "display:none;"><a href = "#rvote" aria-controls="rvote" role="tab" data-toggle="tab">Results</a></li>
				</ul>
			</div>
			<div class = "tab-content">
				<div role="tabpanel" class="tab-pane active" id = "home">Home</div>
				<div role="tabpanel" class="tab-pane" id = "vote">
				
<!--Section for Vote on Administrator End///starts here-->
<h3>Create Vote question</h3>
<form style = "width:500px;" id = "form-vote">
	<div class = "form-group">
		<label for="vote-body">Body</label>
		<textarea class = "form-control" id = "vote-body" placeholder = "Enter question body" style = "height:180px;"></textarea>
	</div>
	<input type = "hidden" name = "count" value = "1" />
	<div class = "control-group" id = "vote-opts">
		<label class = "control-label" for = "opt1">Options</label>
		<div class = "controls" id = "options">
			<div id = "option">
				<input autocomplete="off" class = "input form-control" id = "opt1" name = "vote-opt-1" type = "text" placeholder = "Enter option" />
				<button id = "b1" class = "btn add-more" type = "button">+</button>
			</div>	
		</div>
	</div>
	<div class = "form-group">
		<label for = "vote-time">Time(s)</label>
		<input class = "form-control" id = "vote-time" placeholder = "Enter duration of vote" type = "number" style = "width:200px;" />
	</div>
	<button type = "submit" class = "btn btn-default">Submit</button>
</form>
<!--Section for Vote on Administrator End///ends here-->

				</div>
				<div role="tabpanel" class="tab-pane" id = "trans">Translation</div>
				<div role="tabpanel" class="tab-pane" id = "cvote">
					<!--Cast Vote starts here-->
					<p id = "cast-vote-body"></p>
					<form>
						<div class="form-group" id = "cast-vote-opts">
						</div>	
					</form>
					<br />
					<font>Time to vote: <span id = "timer"></span> seconds</font>
					<!--Cast Vote ends here-->
				</div>
				<div role="tabpanel" class="tab-pane" id = "rvote"><h3>Results</h3></div>
			</div>
		</div>
		<footer id="sp-footer-wrapper">
                	<div class="container">
                        	<div class="row-fluid" id="footer">
					 <div id="sp-footer1" class="span6"><span>Copyright &copy; Homi Bhabha Centre for Science Education, TIFR</span>
					<br /><span>Mumbai - India </span> </div>
                        	</div>
                	</div>
        	</footer>   	
		<!-- jQuery -->
		<script src = "/static/js/jquery.min.js"></script>
		<script src = "/static/js/bootstrap.min.js"></script>
		<script src = "/static/js/Chart.min.js"></script>
		<script src = "/socket.io/socket.io.js"></script>
		<script>
			var socket = io();
			socket.on('end-ack',function(){
				window.location = '/auth.html';
			});
			
			//document ready script
			$(document).ready(function(){
				//for adding options
				var next = 1;
				$(".add-more").click(function(e){
					e.preventDefault();
					var addto = "#opt" + (next);
					var addRemove = "#opt" + (next);
					next = next + 1;
					var newIn = '<input autocomplete = "off" class = "input form-control" id = "opt' + next + '" name = "vote-opt-' + next + '" type = "text" placeholder = "Enter option">';
					var newInput = $(newIn);
					var removeBtn = '<button id = "remove' + (next - 1) + '" class = "btn btn-danger remove-me" >-</button><div></div>';
					var removeButton = $(removeBtn);
					$(addto).after(newInput);
					$(addRemove).after(removeButton);
					$("#count").val(next);
					$('.remove-me').click(function(e){
						e.preventDefault();
						var fieldNum = this.id.substr(6); //length of "remove" + 1 = 6
						var fieldID = "#opt" + fieldNum;	
						$(this).remove();
						$(fieldID).remove();						
					});
				});


				//show tab
				$('#nemo a:first').tab('show');

				//socket.io controls
				$("#logout-button").click(function(){
					socket.emit('end');
				});
				$("#chpass-button").click(function(){
					window.location = '/chpass.html';
				});


				//on receiving vote request
				socket.on('govote',function(id,body,options,time){
				var option,Option;
				$("#cast-vote-opts").html('<div id="divider-container"><div id = "left-opts" class = "left" style = "width:50%"><h5></h5></div><div class = "left" id = "right-opts" style = "position:relative;width:48%"><h5></h5></div><div class = "clear"></div></div>');
				for(var i = 1;i<=options.length;i++){
					option = '<div class = "radio"><label><input type="radio" name = "vote-options" id = "opt'+i+'" value = "opt'+i+'" />'+options[i-1]+'</label></div>';
					Option = $(option);
					$("#left-opts").append(Option);
				}
				
				var Body = $('<font style="font-size:18px;">'+body+'</font>');
				$("#cast-vote-body").append(Body);
				$("#cvoteb").show();
				$("#nemo a:eq(-2)").tab('show');
				clearInterval(timer);
				var timer = setInterval(function(){
					$("#timer").html(time);
					if(time==0) {
					logVote(id);
					clearInterval(timer);
					}	
					time = time-1;
				},1000);
			});

			//results came
			socket.on('voteresults',function(counts,options){
				var canvas = '<div style="width:50%"><canvas id = "canvas" height="450" width = "600"></div>';
				var Canvas = $(canvas);
				$("#rvote").append(Canvas);
				var data = [];
			
				for(var i in counts)
					if(i!='_id' && i!='id')
					{
						data.push(parseInt(counts[i]));
					}	
		
				var barChartData = {
				labels : options,
				datasets : [
				{
					fillColor : "rgba(220,220,220,0.5)",
					strokeColor : "rgba(220,220,220,0.8)",
					highlightFill: "rgba(220,220,220,0.75)",
					highlightStroke: "rgba(220,220,220,1)",
					data : data
				},
				]};
				//TODO:ScrollTo canvas
				var ctx = document.getElementById("canvas").getContext("2d");
				window.myBar = new Chart(ctx).Bar(barChartData, {
				responsive : true
				});
			
				$("#rvoteb").show();
				$("#nemo a:last").tab('show');
			});
			
            function logVote(id)
			{
				var option = $('input[name=vote-options]:checked').val();
				socket.emit('logvote',id,option);
				$('input[name=vote-options]').attr('disabled',true);
				$("#timer").parent().hide();
			}

				//vote form submit
				$("#form-vote").submit(function(e){
					e.preventDefault();
					var body = $("#vote-body").val();
					$("#vote-body").val('');
					var options = [];
					$("#option").find("input").each(function(){
						options.push($(this).val());
						$(this).val('');
					});
					var time = $("#vote-time").val();
					$("#vote-time").val('');
					socket.emit('setvote',body,options,time);
					//have just one option	
					var total = $("input.input").length;
					for(var i = 0;i<total-1;i++)
						$("input.input:eq(0)").remove();
					$(".remove-me").remove();
				});
			});
		</script>
	</body>
</html>
